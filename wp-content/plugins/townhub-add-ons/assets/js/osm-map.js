!function(u){"use strict";function t(){var t=[];return u("#listing-items .listing-item").length&&u("#listing-items .listing-item").each(function(){var e=decodeURIComponent(u(this).data("lmap"));try{t.push(JSON.parse(e))}catch(e){console.log(e)}}),t}function r(e,t,n){return!isNaN(t)&&e<=t&&t<=n}var n={target:"",center:[parseFloat(_townhub_add_ons.center_lng),parseFloat(_townhub_add_ons.center_lat)],zoom:parseInt(_townhub_add_ons.map_zoom),maxZoom:19,map:null,popup:null,olPopup:null,view:null,features:[],vectorSource:null,clusterSource:null,vectorLayer:null,layerRoute:null,extent:null,multiLineString:null,info_tmpl:_.template(u("#tmpl-map-info").length?u("#tmpl-map-info").html():"",{variable:"data",evaluate:/<#([\s\S]+?)#>/g,interpolate:/{{{([\s\S]+?)}}}/g,escape:/{{([^}]+?)}}(?!})/g}),styleCache:{},init:function(e,t){this.target=e,this.initLayerRoute(),this.initPopup(),this.initView(),this.initVectorSource(t),this.initCluster(),this.initVectorLayer(),this.initMap(),this.fitMap(),this.mapInteraction()},initMap:function(){var e={overlays:[this.popup],target:this.target,view:this.view,layers:[new ol.layer.Tile({preload:3,source:new ol.source.OSM}),this.layerRoute,this.vectorLayer],loadTilesWhileAnimating:!0,interactions:ol.interaction.defaults({mouseWheelZoom:!1})};this.map=new ol.Map(e),window.listingsOSMMap=this.map;var t=new CustomEvent("listingsOSMMapInit",{detail:"mapInit"});window.dispatchEvent(t)},fitMap:function(){this.map.getView().fit(this.extent,{size:this.map.getSize(),duration:1e3}),window.dispatchEvent(new CustomEvent("listingsOSMMapLoaded",{detail:"hasListing"}))},toDefaultMap:function(){this.map.getView().animate({zoom:this.zoom,center:ol.proj.fromLonLat(this.center),duration:1e3}),window.dispatchEvent(new CustomEvent("listingsOSMMapLoaded",{detail:"noListing"}))},initView:function(){this.view=new ol.View({center:ol.proj.fromLonLat(this.center),zoom:this.zoom,maxZoom:this.maxZoom})},initPopup:function(){this.olPopup=document.getElementById("ol-popup"),this.popup=new ol.Overlay({element:this.olPopup,autoPan:!0,autoPanAnimation:{duration:250}})},initLayerRoute:function(){this.multiLineString=new ol.geom.MultiLineString([]),this.layerRoute=new ol.layer.Vector({source:new ol.source.Vector({features:[new ol.Feature({geometry:this.multiLineString})]}),style:[new ol.style.Style({stroke:new ol.style.Stroke({width:3,color:[51,51,51,1]}),zIndex:2})],updateWhileAnimating:!0})},initVectorSource:function(e){if(!e.length)return this.vectorSource=new ol.source.Vector({}),!(this.features=[]);this.vectorSource=new ol.source.Vector({}),this.extent=ol.extent.createEmpty();for(var t=0;t<e.length;t++)if(i=e[t].latitude,a=e[t].longitude,i=parseFloat(i),a=parseFloat(a),r(-90,i,90)&&r(-180,a,180)){var n=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([parseFloat(e[t].longitude),parseFloat(e[t].latitude)],"EPSG:4326","EPSG:3857")),name:e[t].title});n.set("popupInfo",this.locationData(e[t]));var o=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",crossOrigin:"anonymous",src:e[t].gmap_marker?e[t].gmap_marker:_townhub_add_ons.marker})});n.setStyle(o),n.setId(e[t].ID),this.features.push(n),this.vectorSource.addFeature(n),ol.extent.extend(this.extent,n.getGeometry().getExtent())}var i,a;return!0},initCluster:function(){this.clusterSource=new ol.source.Cluster({source:this.vectorSource})},initVectorLayer:function(){var i=this;i.vectorLayer=new ol.layer.Vector({source:i.clusterSource,updateWhileAnimating:!0,updateWhileInteracting:!0,style:function(e){var t=e.get("features");if(null!=t){var n=t.length;if(1<n){var o=i.styleCache[n];return o||(o=new ol.style.Style({image:new ol.style.Circle({radius:20,stroke:new ol.style.Stroke({color:"#fff",width:3}),fill:new ol.style.Fill({color:""!=_townhub_add_ons.td_color?_townhub_add_ons.td_color:"#4db7fe"})}),text:new ol.style.Text({text:n.toString(),fill:new ol.style.Fill({color:"#fff"}),font:"13px 'Quicksand', sans-serif"})}),i.styleCache[n]=o),o}return t[0].getStyle()}}})},locationData:function(e){return this.info_tmpl(e)},mapInteraction:function(){var r=this,e=new ol.interaction.Select({condition:function(o){if(!ol.events.condition.singleClick(o))return!1;var i=[],a=[];if(r.map.forEachFeatureAtPixel(o.pixel,function(e,t){if(null!=(a=e.get("features")))for(var n=0;n<a.length;n++)i.push(a[n])}),1<i.length){if(r.map.getView().getZoom()<r.maxZoom){var n=ol.extent.createEmpty();a.forEach(function(e,t){ol.extent.extend(n,e.getGeometry().getExtent())}),r.map.getView().fit(n,r.map.getSize())}else r.map.forEachFeatureAtPixel(o.pixel,function(e,t){var n=e.get("features");r.displayOverlapping(n,o.pixel)});return!1}if(1!==i.length)return r.popup.setPosition(void 0),!1;var e=i[0];r.olPopup.innerHTML=e.get("popupInfo"),r.popup.setPosition(o.coordinate);var t=new CustomEvent("mapPopupOpened",{detail:"osm"});return window.dispatchEvent(t),!1}});r.map.addInteraction(e)},displayOverlapping:function(e,t){if(null!=e){var o=this,n=e[0];if(n){var i=n.getGeometry().getCoordinates(),a=o.map.getPixelFromCoordinate(i),r=o.generatePointsCircle(e.length,a);o.multiLineString.setCoordinates([]),e.forEach(function(e,t){var n=o.map.getCoordinateFromPixel(r[t]);o.multiLineString.appendLineString(new ol.geom.LineString([i,n])),e.setGeometry(new ol.geom.Point(n))})}}},generatePointsCircle:function(e,t){var n=2*Math.PI,o=n/12,i=25*(2+e)/n,a=n/e,r=[],l=void 0,s=void 0;for(l=e-1;0<=l;l--)s=o+l*a,r[l]=[t[0]+i*Math.cos(s),t[1]+i*Math.sin(s)];return r},updateMap:function(e){var t=this,n=t.vectorLayer,o=t.initVectorSource(e);t.initCluster(),t.initVectorLayer();var i=t.map.getLayers();null!=i.remove(n)&&i.push(t.vectorLayer),t.fitMap(),o?t.fitMap():t.toDefaultMap()}};null!=document.getElementById("map-main")&&(u(window).on("load",function(){null!=window._townhub_add_ons_map&&window._townhub_add_ons_map.length?n.init("map-main",window._townhub_add_ons_map):n.init("map-main",t())}),window.addEventListener("listingsChanged",function(e){"ajax_search"==e.detail&&n.updateMap(t())})),u(".singleMap").length&&u(window).on("load",function(){u(".singleMap").each(function(){var e=u(this),t=e.attr("id"),n=[parseFloat(e.data("lng")),parseFloat(e.data("lat"))],o=e.data("loc"),i=e.data("zoom")?parseInt(e.data("zoom")):parseInt(_townhub_add_ons.map_zoom),a=new ol.View({center:ol.proj.fromLonLat(n),zoom:i}),r=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(n,"EPSG:4326","EPSG:3857")),name:o}),l=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",src:_townhub_add_ons.marker,crossOrigin:"anonymous"})});r.setStyle(l);var s=new ol.layer.Vector({source:new ol.source.Vector({features:[r]})});new ol.Map({target:t,view:a,layers:[new ol.layer.Tile({preload:3,source:new ol.source.OSM}),s],loadTilesWhileAnimating:!0,interactions:ol.interaction.defaults({mouseWheelZoom:!1})})})}),u(document).on("click",".autoplace-clear-input",function(e){u(".nearby-inputs-wrap").find(".auto-place-loc").length&&u(".nearby-inputs-wrap").find(".auto-place-loc").val(""),u(".nearby-inputs-wrap").find(".nearby-checkbox").length&&u(".nearby-inputs-wrap").find(".nearby-checkbox").prop("checked",!1),u(".nearby-inputs-wrap").children(".auto-place-nearby").length&&u(".nearby-inputs-wrap").children(".auto-place-nearby").val("off"),u(".nearby-inputs-wrap").children(".auto-place-lat").length&&u(".nearby-inputs-wrap").children(".auto-place-lat").val(""),u(".nearby-inputs-wrap").children(".auto-place-lng").length&&u(".nearby-inputs-wrap").children(".auto-place-lng").val("")})}(jQuery);