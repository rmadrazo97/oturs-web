!function(l){"use strict";function t(){var t=[];return l("#listing-items .listing-item").length&&l("#listing-items .listing-item").each(function(){var e=decodeURIComponent(l(this).data("lmap"));try{t.push(JSON.parse(e))}catch(e){console.log(e)}}),t}function c(e,t,a){return!isNaN(t)&&e<=t&&t<=a}mapboxgl.accessToken=_townhub_add_ons.mbtoken;var d=_.template(l("#tmpl-map-info").length?l("#tmpl-map-info").html():"",{variable:"data",evaluate:/<#([\s\S]+?)#>/g,interpolate:/{{{([\s\S]+?)}}}/g,escape:/{{([^}]+?)}}(?!})/g});function a(e){var t,a,n,o=[];if(Array.isArray(e)&&e.length)for(var l=0;l<e.length;l++)a=e[l].latitude,n=e[l].longitude,a=parseFloat(a),n=parseFloat(n),c(-90,a,90)&&c(-180,n,180)&&o.push({type:"Feature",geometry:{type:"Point",coordinates:[parseFloat(e[l].longitude),parseFloat(e[l].latitude)]},properties:{title:e[l].title,popupContent:(t=e[l],d(t)),"marker-symbol":"monument"}});var r=new mapboxgl.Map({container:"map-main",style:"mapbox://styles/mapbox/streets-v11",center:[parseFloat(_townhub_add_ons.center_lng),parseFloat(_townhub_add_ons.center_lat)],zoom:parseInt(_townhub_add_ons.map_zoom)});r.addControl(new mapboxgl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0}));var i=new mapboxgl.NavigationControl;if(r.addControl(i,"top-left"),r.addControl(new mapboxgl.FullscreenControl),r.on("load",function(){r.loadImage(_townhub_add_ons.marker,function(e,t){if(e)throw e;r.addImage("markerIcon",t),r.addSource("allListings",{type:"geojson",data:{type:"FeatureCollection",crs:{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},features:o},cluster:!0,clusterMaxZoom:14,clusterRadius:50}),r.addLayer({id:"clusters",type:"circle",source:"allListings",filter:["has","point_count"],paint:{"circle-color":"#475897","circle-radius":20}}),r.addLayer({id:"cluster-count",type:"symbol",source:"allListings",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["Roboto Black","Arial Unicode MS Bold"],"text-size":12},paint:{"text-color":"#FFFFFF"}}),r.addLayer({id:"unclustered-point",type:"symbol",source:"allListings",filter:["!",["has","point_count"]],layout:{"icon-image":"markerIcon","icon-size":1}}),r.on("click","clusters",function(e){var a=r.queryRenderedFeatures(e.point,{layers:["clusters"]}),t=a[0].properties.cluster_id;r.getSource("allListings").getClusterExpansionZoom(t,function(e,t){e||r.easeTo({center:a[0].geometry.coordinates,zoom:t})})}),r.on("click","unclustered-point",function(e){for(var t=e.features[0].geometry.coordinates.slice();180<Math.abs(e.lngLat.lng-t[0]);)t[0]+=e.lngLat.lng>t[0]?360:-360;var a=e.features[0].properties.popupContent;null==a&&(a=""),new mapboxgl.Popup({maxWidth:"300px",className:"mapboxgl-popup-wrap"}).setLngLat(t).setHTML(a).addTo(r);var n=new CustomEvent("mapPopupOpened",{detail:"mapbox"});window.dispatchEvent(n)}),r.on("mouseenter","clusters",function(){r.getCanvas().style.cursor="pointer"}),r.on("mouseleave","clusters",function(){r.getCanvas().style.cursor=""})});var t=new mapboxgl.LngLatBounds;0<o.length&&(o.forEach(function(e){t.extend(e.geometry.coordinates)}),r.setCenter(t.getCenter()),r.fitBounds(t,{padding:50}))}),null==window.listingsMapBox){window.listingsMapBox=r;var s=new CustomEvent("listingsMapBoxInit",{detail:"mapInit"});window.dispatchEvent(s)}}function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;null==e&&(e=l(".auto-place-loc")),e.each(function(){var e=l(this).closest(".nearby-input-wrap"),a=l(this).closest(".nearby-inputs-wrap"),t=new MapboxGeocoder({accessToken:mapboxgl.accessToken,placeholder:e.data("placeholder")});t.addTo("#"+e.attr("id")),l(document).on("click",".autoplace-clear-input",function(e){t.clear(),a.find(".nearby-checkbox").length&&a.find(".nearby-checkbox").prop("checked",!1),a.children(".auto-place-nearby").length&&a.children(".auto-place-nearby").val("off"),a.children(".auto-place-lat").length&&a.children(".auto-place-lat").val(""),a.children(".auto-place-lng").length&&a.children(".auto-place-lng").val("")}),t.on("result",function(e){a.find(".nearby-checkbox").length&&a.find(".nearby-checkbox").prop("checked",!0),a.children(".auto-place-nearby").length&&a.children(".auto-place-nearby").val("on");var t=[];null!=e.result&&(null!=e.result.center?t=e.result.center:null!=e.result.geometry&&(t=e.result.geometry.coordinates)),2<=t.length&&(a.children(".auto-place-lat").length&&a.children(".auto-place-lat").val(t[1]),a.children(".auto-place-lng").length&&a.children(".auto-place-lng").val(t[0])),1064<l(window).outerWidth()&&window.doAjaxSearch(document.getElementById("list-search-page-form"))})})}l(".singleMap").length&&l(".singleMap").each(function(){var e=l(this),t=e.attr("id"),a=[parseFloat(e.data("lng")),parseFloat(e.data("lat"))],n=(e.data("loc"),e.data("zoom")?parseInt(e.data("zoom")):parseInt(_townhub_add_ons.map_zoom)),o=new mapboxgl.Map({container:t,style:"mapbox://styles/mapbox/streets-v11",center:a,zoom:n});(new mapboxgl.Marker).setLngLat(a).addTo(o)}),null!=document.getElementById("map-main")&&(null!=window._townhub_add_ons_map&&window._townhub_add_ons_map.length?a(window._townhub_add_ons_map):a(t()),window.addEventListener("listingsChanged",function(e){"ajax_search"==e.detail&&a(t())})),l(".auto-place-loc").length&&document.addEventListener("DOMContentLoaded",function(){n()}),window.addEventListener("filterChanged",function(e){l(".list-search-page-form .auto-place-loc").length&&n(l(".list-search-page-form .auto-place-loc"))}),0<l(".lstreet-view").length&&l(".lstreet-view").each(function(){var e=l(this),t=[parseFloat(e.data("lng")),parseFloat(e.data("lat"))],a=e.data("zoom")?parseFloat(e.data("zoom")):15.5,n=new mapboxgl.Map({style:"mapbox://styles/mapbox/light-v10",center:t,zoom:a,pitch:45,bearing:-17.6,container:e.attr("id"),antialias:!0});(new mapboxgl.Marker).setLngLat(t).addTo(n),n.on("load",function(){for(var e=n.getStyle().layers,t=void 0,a=0;a<e.length;a++)if("symbol"===e[a].type&&e[a].layout["text-field"]){t=e[a].id;break}n.addLayer({id:"3d-buildings",source:"composite","source-layer":"building",filter:["==","extrude","true"],type:"fill-extrusion",minzoom:15,paint:{"fill-extrusion-color":"#aaa","fill-extrusion-height":["interpolate",["linear"],["zoom"],15,0,15.05,["get","height"]],"fill-extrusion-base":["interpolate",["linear"],["zoom"],15,0,15.05,["get","min_height"]],"fill-extrusion-opacity":.6}},t)})})}(jQuery);